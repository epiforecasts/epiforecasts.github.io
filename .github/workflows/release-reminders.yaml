on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:

name: Release reminders

jobs:
  release-reminders:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.RELEASE_REMINDER_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Check packages and create reminders
        run: |
          # Get repos from r-universe + extras
          REPOS=$(curl -s "https://epiforecasts.r-universe.dev/api/packages" | jq -r '.[]._upstream // empty' | sed 's|https://github.com/||')
          REPOS="$REPOS $(grep 'repo:' _data/software-extras.yml | sed 's/.*: //')"

          for repo in $REPOS; do
            echo "Checking $repo..."

            # Get last release info
            RELEASE_INFO=$(gh release view --repo "$repo" --json tagName,createdAt 2>/dev/null || echo '{}')
            LAST_TAG=$(echo "$RELEASE_INFO" | jq -r '.tagName // empty')
            LAST_DATE=$(echo "$RELEASE_INFO" | jq -r '.createdAt // empty')

            if [ -n "$LAST_TAG" ]; then
              # Has releases - skip if released within last 60 days
              if [ -n "$LAST_DATE" ]; then
                DAYS_SINCE=$(( ($(date +%s) - $(date -d "$LAST_DATE" +%s)) / 86400 ))
                if [ "$DAYS_SINCE" -lt 60 ]; then
                  echo "  Released $DAYS_SINCE days ago, skipping"
                  continue
                fi
              fi

              # Check commits since last release (need >1 because version bump after release counts as 1)
              COMMITS=$(gh api "repos/$repo/compare/$LAST_TAG...HEAD" --jq '.ahead_by' 2>/dev/null || echo "0")
              if [ "$COMMITS" -lt 2 ]; then
                echo "  Only $COMMITS commit(s) since last release, skipping"
                continue
              fi

              RELEASE_LINE="**Last release:** $LAST_TAG ($DAYS_SINCE days ago)"
              COMMITS_LINE="**Commits since:** $COMMITS ([view diff](https://github.com/$repo/compare/$LAST_TAG...HEAD))"
            else
              # No releases yet - check if repo has any commits at all
              COMMITS=$(gh api "repos/$repo" --jq '.size' 2>/dev/null || echo "0")
              if [ "$COMMITS" = "0" ]; then
                echo "  Empty repo, skipping"
                continue
              fi

              RELEASE_LINE="**Last release:** None yet"
              COMMITS_LINE=""
              DAYS_SINCE="N/A"
            fi

            # Check if reminder already exists this month
            MONTH=$(date +'%B %Y')
            EXISTING=$(gh issue list --repo "$repo" --search "Release reminder - $MONTH in:title" --json number --jq 'length' 2>/dev/null || echo "0")
            if [ "$EXISTING" != "0" ]; then
              echo "  Reminder already exists for $MONTH, skipping"
              continue
            fi

            # Get open bugs
            BUGS=$(gh issue list --repo "$repo" --label bug --state open --json number,title --jq '.[] | "- #\(.number) \(.title)"' 2>/dev/null || echo "")
            if [ -z "$BUGS" ]; then
              BUGS="None"
            fi

            # Get open PRs
            PRS=$(gh pr list --repo "$repo" --state open --json number,title --jq '.[] | "- #\(.number) \(.title)"' 2>/dev/null || echo "")
            if [ -z "$PRS" ]; then
              PRS="None"
            fi

            # Create reminder issue
            echo "  Creating reminder for $repo"
            {
              echo "$RELEASE_LINE"
              [ -n "$COMMITS_LINE" ] && echo "$COMMITS_LINE"
              echo "**What's new:** [NEWS.md](https://github.com/$repo/blob/HEAD/NEWS.md)"
              echo ""
              echo "**Open bugs:**"
              echo "$BUGS"
              echo ""
              echo "**Open PRs:**"
              echo "$PRS"
              echo ""
              echo "## Release checklist"
              echo '- [ ] `revdepcheck::revdep_check()` (if package has dependents)'
              echo '- [ ] `usethis::use_version()`'
              echo '- [ ] `devtools::submit_cran()`'
              echo '- [ ] After acceptance: `usethis::use_github_release()`'
              echo ""
              echo "*Close this issue if not releasing this cycle.*"
            } > /tmp/release-body.md
            # Ensure 'release' label exists, create issue without label if it fails
            gh label create release --repo "$repo" --description "Release tracking" --color "0E8A16" 2>/dev/null || true
            gh issue create --repo "$repo" \
              --title "Release reminder - $MONTH" \
              --label "release" \
              --body-file /tmp/release-body.md 2>/dev/null \
            || gh issue create --repo "$repo" \
              --title "Release reminder - $MONTH" \
              --body-file /tmp/release-body.md \
            || echo "  Failed to create issue for $repo"
          done
